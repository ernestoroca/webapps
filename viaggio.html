<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viaggio Usuarios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
      rel="stylesheet">
    <script src="commonviaggio.js"></script>
    <script src="reportes.js"></script>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">
          <img src="viaggio.jpeg" alt="Logo" width="120" height="24" class="d-inline-block align-text-top">
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNavAltMarkup"
          aria-controls="navbarNavAltMarkup"
          aria-expanded="false"
          aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
          <div class="navbar-nav">
            <a class="nav-link" href="reservas.html">Reservas</a>
            <a class="nav-link" href="importaciones.html">Importaciones</a>
            <a class="nav-link" href="usuarios.html">Usuarios</a>
            <a class="nav-link" href="reportes.html">Reportes</a>
          </div>
        </div>
      </div>
    </nav>
    <div class="container">
      <div class="row">
        <div class="col-sm-6 col-12">
          <br>    
          <label for="sucursal-sel">Sucursal:</label>
          <select class="form-select" aria-label="Sucursal" id="sucursal-sel">
            <option value="">...</option>
          </select>
        </div>
        <div class="col-sm-6 col-12">
          <br>
          <label for="sucursal-sel">Ejecutivo de Ventas:</label>
          <select class="form-select" aria-label="Vendedor" id="vendedor-sel">
            <option value="">...</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="col col-sm-2 text-center">
          <button type="button" class="btn" id="retro">
            <i class="fa fa-chevron-left fa-2x"></i>
          </button>
        </div>
        <div class="col col-sm-8 text-center" id="titulo">
          <h1></h1>
        </div>
        <div class="col col-sm-2 text-center">
          <button type="button" class="btn" id="avanza">
            <i class="fa fa-chevron-right fa-2x"></i>
          </button>
        </div>
      </div>
      <div class="row">
        <div style="overflow-x: auto;white-space: nowrap;">
          <table class="table table-striped">
            <thead>
              <tr>
                <th scope="col" class="bg-secondary text-white">Sucursal</th>
                <th scope="col" class="bg-secondary text-white">Ejecutivo</th>
                <th scope="col" class="bg-secondary text-white">Fecha</th>
                <th scope="col" class="bg-secondary text-white">VIN</th>
                <th scope="col" class="bg-secondary text-white">Modelo</th>
              </tr>
            </thead>
            <tbody id="cuerpo"></tbody>
          </table>
        </div>
      </div>
    </div>
    <script>

let miUsuarioTipo = localStorage.getItem("miUsuarioTipo");

miUsuarioTipo = "admin"; //BORRAR

if(!miUsuarioTipo || miUsuarioTipo !== "admin"){
    window.location.href = "reservas.html";
}
let anho,mes;

function setFechaInicio(){
    let hoy = new Date();
    anho = hoy.getFullYear();
    mes = hoy.getMonth()+1;
    document.getElementById("titulo").innerHTML = "<b>"+mes+"/"+anho+"</b>";
}

function printItem(datos){
    let tr = document.createElement("TR");
    let str = `
    <tr>
      <td class="bg-secondary
      text-white">${datos.datosVendedor.sucursal}</td>
      <td class="bg-secondary text-white">${datos.datosVendedor.nombres} ${datos.datosVendedor.apellidos}</td>
      <td class="bg-secondary text-white">${datos.fecha}</td>
      <td class="bg-secondary text-white">${datos.vin}</td>
      <td class="bg-secondary text-white">${datos.fila[1]}</td>
    </tr>`;
    tr.innerHTML = str;
    document.getElementById("cuerpo").appendChild(tr);
}

function printVendedor(lista,elVendedor){
    let len  = lista.length;
    for(let i=0;i<len;i++){
        if(lista[i].vendedor === elVendedor){
            printItem(lista[i]);
        }
    }
}

function printSucursal(lista,laSucursal){
    let len = lista.length;
    for(let i=0;i<len;i++){
        if(lista[i].datosVendedor.sucursal === laSucursal){
            printItem(lista[i]);
        }
    }
}

function printTodas(lista){
    let len = lista.length;
    for(let i=0;i<len;i++){
        printItem(lista[i]);
    }
}

function setSucursal(){
    let laSucursal = document.getElementById("sucursal-sel").value;
    let listaVendedores = Datos.getVendedores(laSucursal);
    let len = listaVendedores.length;
    let lista = `<option value="">...</option>`;
    for(let i=0;i<len;i++){
        let unVendedor = listaVendedores[i];
        lista += `<option value="${unVendedor.id}">${unVendedor.nombres} ${unVendedor.apellidos}</option>`;
    }
    lista += `<option value="TODOS">TODOS</option>`;
    document.getElementById("vendedor-sel").innerHTML = lista;
}

function setVendedor(){
    document.getElementById("cuerpo").innerHTML = "";
    let elVendedor = document.getElementById("vendedor-sel").value;
    if(elVendedor === ""){
        return;
    }
    if(elVendedor !== "TODOS"){
        Datos.getMes(anho,mes).then((lista) => {
            printVendedor(lista,elVendedor);
        });
        return;
    }
    let laSucursal = document.getElementById("sucursal-sel").value;
    if(laSucursal === ""){
        return;
    }
    if(laSucursal !== "TODAS"){
        Datos.getMes(anho,mes).then((lista) => {
            printSucursal(lista,laSucursal);
        });
        return;
    }
    Datos.getMes(anho,mes).then((lista) => {
        printTodas(lista);
    })
}

function printSucursales(){
    let lasSucursales = Datos.getSucursales();
    let len = lasSucursales.length;
    let lista = `<option value="">...</option>`;
    for(let i=0;i<len;i++){
        let unaSucursal = lasSucursales[i];
        lista += `<option value="${unaSucursal}">${unaSucursal}</option>`;
    }
    lista += `<option value="TODAS">TODAS</option>`;
    document.getElementById("sucursal-sel").innerHTML = lista;
}

window.onload = function() {
    Datos.iniciar().then(() => {
        printSucursales();
        setFechaInicio();
    });
};

document.getElementById("sucursal-sel").onchange = setSucursal;
document.getElementById("vendedor-sel").onchange = setVendedor;

window.document.getElementById("avanza").onclick = function(){
    mes++;
    if(mes > 12){
        mes = 1;
        anho++;
    }
    document.getElementById("titulo").innerHTML = "<b>"+mes+"/"+anho+"</b>";
    setVendedor();
};
window.document.getElementById("retro").onclick = function(){
    mes--;
    if(mes < 1){
        mes = 12;
        anho--;
    }
    document.getElementById("titulo").innerHTML = "<b>"+mes+"/"+anho+"</b>";
    setVendedor();
};

    </script>
  </body>
</html>
