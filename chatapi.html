<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat API</title>
<link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css">
<script src="llmlab.js"></script>
<script src="common.js"></script>
</head>
<body>

<div class="w3-container">
  <div class="w3-row">
    <div class="w3-col s4">
      <button class="w3-button w3-round w3-blue" id="show-modelos">Modelos</button>
    </div>
    <div class="w3-col s4">
      <button class="w3-button w3-round w3-blue" id="show-agentes">Agentes</button>
    </div>
    <div class="w3-col s4">
      <button class="w3-button w3-round w3-blue" id="show-chats">Chats</button>
    </div>
  </div><br>
  <div id="form-modelos"></div>
  <div id="form-agentes"></div>
  <div id="form-chats"></div><br>
</div>
<script>
function formKey(){
    let keyX = Llms.getKey();
    keyX = (keyX)?"****":"";
    let strHTML = `
    <form class="w3-container">
      <p>
        <label>OpenGateway Key</label>
        <input class="w3-input" type="text" id="modal-key" value="${keyX}">
      </p>
      <p>
        <button id="modal-guardar" class="w3-btn w3-green">Modificar</button>
        <button id="modal-borrar" class="w3-btn w3-red">Borrar</button>
      </p>
    </form>
    `;
    W3.modal(strHTML);
    document.getElementById("modal-guardar").onclick = function(){
        let key = document.getElementById("modal-key").value;
        if(key === ""){
            return;
        }
        Llms.setKey(key);
    };
    document.getElementById("modal-borrar").onclick = function(){
        Llms.delKey();
    };
}

function printLlms(){
    let lista = Llms.getLlms();
    let len = lista.length;
    let options = "";
    for(let i=0;i<len;i++){
        options += `<option value="${lista[i]}">${lista[i]}</option>`;
    }
    document.getElementById("select-llms").innerHTML = options;
     
}

function printModelos(){
    let llm = document.getElementById("select-llms").value;
    let lista = Llms.getModels(llm);
    let len = lista.length;
    let options = "";
    for(let i=0;i<len;i++){
        options += `<option value="${lista[i]}">${lista[i]}</option>`;
    }
    document.getElementById("select-modelos").innerHTML = options;
    modelData();
}

function modelData(){
    let llm = document.getElementById("select-llms").value;
    let model = document.getElementById("select-modelos").value;
    let data = Llms.getData(llm,model);
    let pricing = data.pricing;
    
    //millon de tokens por 1 dolar
    let valor = 1/(parseFloat(pricing.prompt)*1000000);
    let str = "" + valor.toFixed(3) +" / ";
    valor = 1/(parseFloat(pricing.completion)*1000000);
    str += valor.toFixed(3);
    
    //dolares por página
    valor = parseFloat(pricing.prompt)*1154;
    str += "   ; " + valor.toFixed(3);
    valor = parseFloat(pricing.completion)*1154;
    str += " / " + valor.toFixed(3);
    document.getElementById("precios").innerHTML = str;
}

function printAgentes(){
    let lista = Prompts.list();
    let len = lista.length;
    let strHtml = `<button class="w3-button w3-round w3-blue" id="agente-VACIO">Vacío</button>`;
    for(let i=0;i<len;i++){
        strHtml += `<button class="w3-button w3-round w3-blue" id="agente-${lista[i]}">${lista[i]}</button>`;
    }
    strHtml += `<button class="w3-button w3-round w3-blue" id="agente-NUEVO">+</button>`;
    document.getElementById("lista-agentes").innerHTML = strHtml;
}

function printChats(){
    let lista = Chat.list();
    let len = lista.length;
    let strHtml = ``;
    for(let i=0;i<len;i++){
        strHtml += `<button class="w3-button w3-round w3-blue" id="Chat-${lista[i].key}">${lista[i].title}</button>`;
    }
    strHtml += `<button class="w3-button w3-round w3-blue" id="Chat-NUEVO">+</button>`;
    document.getElementById("lista-chats").innerHTML = strHtml;
}

function printConversacion(){
    let lista = Chat.readChat();
    let len = lista.length;
    let strHtml = ``;
    for(let i=0;i<len;i++){
        let item = lista[i];
        if(item.role === "user"){
          strHtml += `
<div class="w3-panel w3-pale-green w3-leftbar w3-border-green">
  <p>${item.content}</p>
</div>`;
        } else {
          strHtml += `
<div class="w3-panel w3-pale-red w3-leftbar w3-border-red">
  ${item.content}
</div>`;
        }
        
    }
    document.getElementById("conversacion-chat").innerHTML = strHtml;
}
    

window.onload = function(){
    formKey();
    Llms.init();
};

var llmSelect = null;
var modelSelect = null;
var agenteSelect = null;
var chatSelect = null;
    

document.getElementById("show-modelos").onclick = function(){
    document.getElementById("form-agentes").innerHTML = "";
    document.getElementById("form-modelos").innerHTML = `
  <div class="w3-row">  
    <div class="w3-col s6">
      <select class="w3-select" name="select-llms" id="select-llms"></select>
    </div>
    <div class="w3-col s6">
      <select class="w3-select" name="select-modelos" id="select-modelos"></select>
    </div>
    <div class="w3-col s12">
      <p id="precios"></p>
    </div>
  </div>
    `;
    printLlms();
    if(llmSelect !== null){
        document.getElementById("select-llms").value = llmSelect;
    } else {
        llmSelect = document.getElementById("select-llms").value;
    }
    
    printModelos();
    if(modelSelect !== null){
        document.getElementById("select-modelos").value = modelSelect;
    } else {
        modelSelect = document.getElementById("select-modelos").value;
    }
    
    modelData();

    document.getElementById("select-llms").onchange = function(){
        llmSelect = document.getElementById("select-llms").value;
        printModelos();
    };
    
    document.getElementById("select-modelos").onchange = function(){
        modelSelect = document.getElementById("select-modelos").value;
        modelData();
    };
};

document.getElementById("show-agentes").onclick = function(){
    document.getElementById("form-modelos").innerHTML = "";
    document.getElementById("form-agentes").innerHTML = `
  <div class="w3-row">  
    <div class="w3-col s12" id="lista-agentes"></div>
  </div>
  <div class="w3-row">  
    <div class="w3-col s12">
      <p>      
        <label class="w3-text-blue"><b>Título</b></label>
        <input class="w3-input w3-border" name="agente-titulo" type="text" id="agente-titulo">
      </p>
      <p>      
        <label class="w3-text-blue"><b>Prompt</b></label>
        <textarea class="w3-input w3-border" id="agente-prompt"></textarea>
      </p>
      <p>      
        <button class="w3-btn w3-blue" id="agente-enviar">Enviar</button>
      </p>
    </div>
  </div>
    
    `;
    
    printAgentes();
    document.getElementById("lista-agentes").onclick = function (event){
        event.preventDefault();
        let target = event.target;
        while(target.id === ""){
            target = target.parentNode;
        }
        if(!target.id.includes("agente-")){
            return;
        }
        agenteSelect = target.id.replace("agente-","");
        if(agenteSelect === "VACIO"){
            titulo = "VACIO";
            prompt = "VACIO";
        } else if(agenteSelect === "NUEVO"){
            titulo = "";
            prompt = "";
        } else {
            let unPrompt = Prompts.read(agenteSelect);
            titulo = unPrompt.label;
            prompt = unPrompt.system;
        }
        document.getElementById("agente-titulo").value = titulo;
        document.getElementById("agente-prompt").value = prompt;
    }
    document.getElementById("agente-enviar").onclick = function(event){
        event.preventDefault();
        if(agenteSelect === null){
            return;
        }
        if(agenteSelect === "VACIO"){
            return;
        }
        
        let titulo = document.getElementById("agente-titulo").value;
        let prompt = document.getElementById("agente-prompt").value;
        
        if(agenteSelect === "NUEVO"){
            Prompts.create(titulo,prompt,"");
        } else {
            Prompts.update(agenteSelect,titulo,prompt,"");
        }
        printAgentes();
    }
};

document.getElementById("show-chats").onclick = function(){
    document.getElementById("form-chats").innerHTML = `
  <div class="w3-row">  
    <div class="w3-col s12" id="lista-chats"></div>
  </div>
  <div id="conversacion-chat"></div>
  <div class="w3-row">  
    <div class="w3-col s12">
      <p>      
        <input class="w3-input w3-border" name="pregunta-chat" type="text" id="pregunta-chat">
      </p>
      <p>      
        <button class="w3-btn w3-blue" id="pregunta-enviar">Enviar</button>
        <button class="w3-btn w3-red" id="chat-borrar">BORRAR</button>
        <button class="w3-btn w3-orange" id="chat-bifurcar">Bifurcar</button>
      </p>
    </div>
  </div>
    `;
    
    printChats();
    document.getElementById("lista-chats").onclick = function (event){
        event.preventDefault();
        let target = event.target;
        while(target.id === ""){
            target = target.parentNode;
        }
        if(!target.id.includes("Chat-")){
            return;
        }
        document.getElementById("conversacion-chat").innerHTML = "";
        document.getElementById("pregunta-chat").value = "";
        
        chatSelect = target.id.replace("Chat-","");
        if(chatSelect !== "NUEVO"){
            Chat.setParams(llmSelect,modelSelect,agenteSelect);
            Chat.initChat(chatSelect);
            printConversacion()
        } else {
            chatSelect = Chat.create("");
            Chat.setParams(llmSelect,modelSelect,agenteSelect);
            Chat.initChat(chatSelect);
        }
    }
    document.getElementById("pregunta-enviar").onclick = function(event){
        event.preventDefault();
        if(agenteSelect === null){
            return;
        }
        if(agenteSelect === "VACIO"){
            return;
        }
        
        let pregunta = document.getElementById("pregunta-chat").value.trim();
        
        if(pregunta === ""){
            return;
        }
        Chat.ask(pregunta).then((respuesta)=>{
          let div = document.createElement("div");
          div.classList.add("w3-panel","w3-pale-green","w3-leftbar","w3-border-green");
          div.innerHTML = "<p>"+pregunta+"</p>";
          document.getElementById("conversacion-chat").appendChild(div);

          div = document.createElement("div");
          div.classList.add("w3-panel","w3-pale-red","w3-leftbar","w3-border-red");
          div.innerHTML = respuesta.message;
          document.getElementById("conversacion-chat").appendChild(div);

          document.getElementById("pregunta-chat").value = "";
        });
    }
    document.getElementById("chat-borrar").onclick = function(event){
      event.preventDefault();
      Chat.delete(chatSelect);
      document.getElementById("conversacion-chat").innerHTML = "";
      printChats();
    }
};


</script>
</body>
</html>
